<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>Show do Crentão — Sobrenatural Church</title>
  <meta name="theme-color" content="#000000" />
  <style>
    :root{
      --bg:#000; --green:#1fddac; --green-700:#0fa17e; --white:#ffffff;
      --card:#0c0f0f; --muted:#aab3b1; --radius:14px;
      --shadow:0 12px 40px rgba(0,0,0,.45); --shadow-soft:0 8px 20px rgba(0,0,0,.35);
      --pad: clamp(16px, 3vw, 28px); --maxw: 1040px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;background:#000;color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial}
    img{display:block;max-width:100%}
    .hidden{display:none !important}
    header{position:fixed; inset:0 0 auto 0; height:56px; display:flex; align-items:center; justify-content:space-between; padding:0 var(--pad); z-index:40; pointer-events:none; background:linear-gradient(180deg,rgba(0,0,0,.55),rgba(0,0,0,0));}
    .brand, .right{pointer-events:auto; display:flex; align-items:center; gap:12px;}
    .brand img{height:22px; opacity:.95}
    .title-logo{height:26px; opacity:.96; filter: drop-shadow(0 2px 8px rgba(0,0,0,.45)); display:none;}
    @media (max-width:768px){ .title-logo{height:22px;} }
    #hero{position:relative; min-height:100svh; display:flex; align-items:flex-end; justify-content:center; padding: calc(56px + 10svh) var(--pad) calc(20svh); background:#000; overflow:hidden; opacity:1; transform:none;}
    #hero .bg{ position:absolute; inset:0; z-index:0; display:grid; place-items:center;}
    #heroImg{ width:100%; height:100%; object-fit:cover; user-select:none; -webkit-user-drag:none; filter:none; }
    @media (max-width: 768px){ #hero{padding: calc(56px + 6svh) var(--pad) calc(18svh);} #heroImg{ object-fit:contain; aspect-ratio:auto; object-position: center 70px; } }
    #hero .cta{position:absolute; left:50%; transform:translateX(-50%); bottom: calc(12svh + env(safe-area-inset-bottom)); width:100%; max-width: min(780px, 92vw); display:flex; gap:14px; flex-wrap:wrap; justify-content:center; z-index:2;}
    .btn{appearance:none; border:0; border-radius:18px; padding:18px 28px; font-weight:800; letter-spacing:.02em; text-transform:uppercase; cursor:pointer; box-shadow: var(--shadow); transition: transform .08s ease, box-shadow .2s ease, opacity .2s ease, filter .2s ease;}
    .btn:active{transform: translateY(1px); box-shadow: var(--shadow-soft);}
    .btn.primary{ background:linear-gradient(180deg, var(--green) 0%, var(--green-700) 100%); color:#06261f; }
    .btn.secondary{ background:var(--white); color:#0a0d0c }
    .btn.full{ flex:1 1 320px; }
    main{display:grid; gap:28px; padding:24px var(--pad) 48px; max-width:var(--maxw); margin:0 auto}
    .card{background:rgba(12,15,15,.72); backdrop-filter: blur(6px); border:1px solid rgba(255,255,255,.06); border-radius:var(--radius); box-shadow:var(--shadow); padding: min(28px, 3.2vw);}
    h2{margin:0 0 6px; font-size:22px}
    .sub{margin:0 0 14px; font-size:14px; color:#a7b1af}
    label{display:block; font-size:14px; margin:14px 0 6px; color:#cdd5d3}
    input[type="text"], input[type="tel"]{width:100%; padding:14px 16px; border-radius:12px; border:1px solid rgba(255,255,255,.08); background:#0b0f0e; color:#fff; outline:none;}
    .help{font-size:13px; color:#93a29f; margin-top:10px}
    .row{display:flex; gap:12px; flex-wrap:wrap}
    .row .btn{min-width:160px}
    #section-form, #section-quiz, #section-ranking{display:none}
    .confirm-box{ margin-top:14px; padding:12px; border-radius:12px; border:1px solid rgba(255,255,255,.08); background:#0a0f0f; }
    .confirm-title{font-weight:800; margin-bottom:10px;}
    .helpbox{margin-top:12px; font-size:13px; color:#a7b1af}
    #fxOverlay{ position:fixed; inset:0; pointer-events:none; z-index:60; }
    .fx-ok::after{content:""; position:absolute; inset:0; margin:auto; width:min(55vmin,520px); height:min(55vmin,520px); border-radius:50%; background:radial-gradient(ellipse at center, rgba(31,221,172,.28), rgba(31,221,172,0) 60%); animation:okPulse .95s ease-out forwards;}
    @keyframes okPulse{ 0%{transform:scale(.7); opacity:.0} 25%{opacity:.9} 100%{transform:scale(1.15); opacity:0} }
    .fx-wrong{ animation:shake .6s ease-in-out 0s 1; }
    .fx-wrong::after{content:""; position:absolute; inset:0; background:radial-gradient(ellipse at center, rgba(242,78,58,.18), rgba(242,78,58,0) 65%); animation:fadeOut .8s ease forwards;}
    @keyframes shake{0%,100%{transform:translateX(0)}20%{transform:translateX(-10px)}40%{transform:translateX(10px)}60%{transform:translateX(-6px)}80%{transform:translateX(6px)}}
    @keyframes fadeOut{ from{opacity:.9} to{opacity:0} }
  </style>
</head>
<body>
  <header>
    <div class="brand"><img src="img/logo.png" alt="Sobrenatural Church" onerror="this.style.display='none'"></div>
    <div class="right"><img id="crentaoLogo" class="title-logo" src="img/logosc.png" alt="Show do Crentão" /></div>
  </header>
  <section id="hero">
    <div class="bg"><img id="heroImg" src="img/cover.png" alt="Capa – Show do Crentão"></div>
    <div class="cta"><button id="btnStart" class="btn primary full">Iniciar</button><button id="btnRanking" class="btn secondary full">Ranking</button></div>
  </section>
  <main>
    <section id="section-form" class="card">
      <h2>Dados do participante</h2>
      <label>Nome completo</label>
      <input id="nome" type="text" placeholder="Ex.: Maria Silva">
      <div class="help">Cada pessoa pode responder <strong>uma única vez</strong> por evento.</div>
      <div class="row" style="margin-top:16px"><button id="btnEnviarDados" class="btn primary">Começar Quiz</button></div>
    </section>

    <section id="section-quiz" class="card">
      <h2 id="quizPergunta">Pergunta</h2>
      <p id="valorPergunta" class="sub"></p>
      <div id="quizOpcoes"></div>
      <div class="row" style="margin-top:14px">
        <button id="btnResponder" class="btn primary">Enviar resposta</button>
        <button id="btnParar" class="btn secondary">Parar agora</button>
        <button id="btnPular" class="btn secondary">Pular</button>
      </div>
      <div id="ajudaBox" class="helpbox hidden"></div>
    </section>

    <section id="section-ranking" class="card">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
        <h2>Ranking</h2>
        <a href="index.html" class="btn secondary">Voltar para a home</a>
      </div>
      <div id="rankingLista" class="help">Sem participantes por enquanto.</div>
    </section>
  </main>

  <div id="fxOverlay" aria-hidden="true"></div>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
const SUPA_URL = "https://ihajmegcdgwchxslnaep.supabase.co";
const SUPA_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImloYWptZWdjZGd3Y2h4c2xuYWVwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY0OTQzMTgsImV4cCI6MjA3MjA3MDMxOH0.WM36lA9n0PU9qd-DKdrWVB_UzGVXpsfJ984oHiXDU8Y";
const supabase = createClient(SUPA_URL, SUPA_KEY);

// refs
const hero = document.getElementById('hero');
const secForm = document.getElementById('section-form');
const secQuiz = document.getElementById('section-quiz');
const secRank = document.getElementById('section-ranking');
const btnStart = document.getElementById('btnStart');
const btnRanking = document.getElementById('btnRanking');
const btnEnviar = document.getElementById('btnEnviarDados');
const btnResponder = document.getElementById('btnResponder');
const btnParar = document.getElementById('btnParar');
const btnPular = document.getElementById('btnPular');
const nome = document.getElementById('nome');
const elPerg = document.getElementById('quizPergunta');
const elSub = document.getElementById('valorPergunta');
const elOps = document.getElementById('quizOpcoes');
const ajudaBox = document.getElementById('ajudaBox');

// escada de "talentos"
const ladder = [100,200,300,500,1000,2000,5000,10000,20000,50000,100000,200000,300000,500000,750000,1000000];
const checkpoints = new Set([4,9,14]); // 5/10/15

// estado
let participante = null;
let perguntas = []; // perguntas sorteadas na sessão
let pool = [];      // pool remanescente (para pular)
let idx = 0;        // índice da fase (0..15)
let acertos = 0;    // quantas acertou
let escolha = null; // 'a'|'b'|'c'|'d'
let skipUsado = false; // uma vez só

// navegação
btnStart.onclick = ()=>{ hero.style.display='none'; secForm.style.display='block'; };
btnRanking.onclick = ()=>{ hero.style.display='none'; secRank.style.display='block'; renderRanking(); };

btnEnviar.onclick = async ()=>{
  const n = (nome.value||'').trim();
  if(!n) { alert('Preencha seu nome.'); return; }
  participante = { nome:n };
  // carrega perguntas ativas do Supabase
  const { data, error } = await supabase.from('perguntas').select('*').eq('ativa', true);
  if(error){ alert('Erro ao carregar perguntas'); console.error(error); return; }
  // embaralha e pega 16
  pool = shuffle(data.slice());
  perguntas = pool.splice(0,16); // tira 16 da pool
  // inicia
  secForm.style.display='none'; secQuiz.style.display='block';
  idx = 0; acertos = 0; skipUsado = false; escolha = null;
  renderPergunta();
};

btnResponder.onclick = ()=>{
  if(escolha==null){ alert('Escolha uma alternativa.'); return; }
  const p = perguntas[idx];
  const ok = (escolha === (p.correta||'').toLowerCase());
  if(ok){
    acertos++;
    // avançamos de fase
    idx++;
    if(idx >= perguntas.length){ return finalizar('fim'); }
    escolha = null;
    renderPergunta();
  }else{
    // errou: cai para o último checkpoint garantido
    return finalizar('erro');
  }
};

btnParar.onclick = ()=>{
  // parar SEM responder a atual: leva o último checkpoint garantido
  finalizar('parou');
};

btnPular.onclick = ()=>{
  if(skipUsado) return; // só 1 pulo
  skipUsado = true;
  // pular NÃO muda de fase: mantém idx e substitui a pergunta por outra do mesmo pool
  if(pool.length===0){
    // se não houver mais no pool, apenas reembaralha as que não foram respondidas
    pool = shuffle(perguntas.slice(idx+1));
  }
  // escolhe uma nova pergunta para esta fase
  const nova = pool.shift();
  if(nova){ perguntas[idx] = nova; }
  escolha = null;
  renderPergunta();
};

function renderPergunta(){
  const p = perguntas[idx];
  if(!p){ return finalizar('fim'); }
  // Título: APENAS o enunciado (sem "1 de 16")
  elPerg.textContent = p.enunciado;
  elSub.textContent = `Vale ${ladder[idx].toLocaleString('pt-BR')} talento(s)`;
  ajudaBox.classList.add('hidden'); ajudaBox.innerHTML='';
  elOps.innerHTML = '';
  ['a','b','c','d'].forEach(k=>{
    const txt = p[`opcao_${k}`];
    if(txt){
      const lab = document.createElement('label');
      lab.style.cssText = 'display:flex;gap:10px;align-items:center;margin:10px 0';
      lab.innerHTML = `<input type="radio" name="op" value="${k}"> <span>${txt}</span>`;
      elOps.appendChild(lab);
    }
  });
  elOps.querySelectorAll('input[name=op]').forEach(r=>r.addEventListener('change',()=>{ escolha=r.value; }));
}

function calculaGarantido(){
  // garantido depende do último checkpoint que JÁ PASSOU (acertos)
  if(acertos===0) return 0;
  if(acertos===ladder.length) return ladder[ladder.length-1];
  let premio = 0;
  for(let i=0;i<acertos;i++){ if(checkpoints.has(i)) premio = ladder[i]; }
  return premio;
}

async function finalizar(modo){
  // modos: 'parou' | 'erro' | 'fim'
  let tesouro = 0;
  if(modo==='parou'){
    tesouro = calculaGarantido();
  }else if(modo==='erro'){
    tesouro = calculaGarantido();
  }else{ // fim (acertou todas)
    tesouro = acertos===ladder.length ? ladder[ladder.length-1] : calculaGarantido();
  }

  // salva no Supabase
  try{
    await supabase.from('ranking').insert([{ nome:participante.nome, pontos: acertos, tesouro }]);
  }catch(e){ console.error(e); }

  // mostra ranking
  secQuiz.style.display='none'; secRank.style.display='block';
  renderRanking();
}

async function renderRanking(){
  const box = document.getElementById('rankingLista');
  const { data, error } = await supabase.from('ranking').select('*');
  if(error){ box.textContent = 'Erro ao carregar ranking.'; console.error(error); return; }
  if(!data || !data.length){ box.textContent = 'Sem participantes por enquanto.'; return; }
  data.sort((a,b)=> b.tesouro - a.tesouro || b.pontos - a.pontos || a.quando - b.quando);
  box.innerHTML = data.map((r,i)=>`<div style="padding:6px 0;border-bottom:1px solid rgba(255,255,255,.06)">${i+1}. ${r.nome} — ${Number(r.tesouro||0).toLocaleString('pt-BR')} talento(s) · ${r.pontos||0} acerto(s)</div>`).join('');
}

function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()* (i+1)); [arr[i],arr[j]]=[arr[j],arr[i]];} return arr; }
</script>
</body>
</html>
